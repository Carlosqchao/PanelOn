<form #uploadForm="ngForm" (ngSubmit)="onSubmit(uploadForm)">
  <div class="aside-img">
    <img src="https://media.mycomicshop.com/n_iv/600/1168751.jpg" alt="Comic Cover">
  </div>
  <div class="form-container">
    <div class="inner-form-container">
      <div class="file-upload">
        <div class="circle" [ngClass]="{ 'circle-empty': filePreview }">
          <label for="file" class="file-label">
            <ng-container *ngIf="!filePreview; else fileIcon">
              <i class="fas fa-upload fa-2x"></i>
            </ng-container>

            <ng-template #fileIcon>
              <div class="file-preview">
                <i class="fas fa-file-pdf fa-3x"></i>
                <br>
                <p>{{ getShortFileName(selectedFile?.name) }}</p>
              </div>
            </ng-template>

            <input type="file" id="file" (change)="onFileSelected($event)" name="file" style="display: none">
          </label>
        </div>
        <div *ngIf="formSubmitted && (!isFileValid() || invalidFile || !isSizeValid)" class="file-warning">
          <p style="color: red;">
            Please select a valid PDF. Max size: 100MB.
          </p>
        </div>
      </div>

      <div *ngIf="nsfwResult">
        <div *ngIf="loadingStatus === 'clean'" class="message clean-message">
          ✅ The PDF is clean. PEGI Suggested: {{ nsfwResult.pegi }}
        </div>
        <div *ngIf="loadingStatus === 'nsfw'" class="message nsfw-message">
          ⚠️ The PDF violates the Terms and Conditions.
        </div>
      </div>

      <div *ngIf="loadingStatus" class="progress-bar">
        <div class="progress" [ngClass]="{
            'loading': loadingStatus === 'loading',
            'clean': loadingStatus === 'clean',
            'nsfw': loadingStatus === 'nsfw'
        }"></div>
      </div>

      <a style="cursor: pointer" *ngIf="!isAnalyzingFile && nsfwResult?.nsfw === true && loadingStatus !== 'loading'" (click)="openModal()">Details</a>

      <div *ngIf="modalVisible && nsfwResult != null" class="modal">
      <div class="modal-content">
          <span class="close" (click)="closeModal()">&times;</span>
          <h2>Imágenes de análisis NSFW</h2>
          <div *ngFor="let image of imagePreviews">
            <img [src]="image" alt="Previsualización" class="preview-image"/>
          </div>
        </div>
      </div>
      <div style="align-self: flex-start;">
        <nav aria-label="Go back">
          <a id="back-link" href="#" onclick="history.back(); return false" style="color: black"> &larr; Go back</a>
        </nav>
      </div>

      <div class="title">
        <input
          type="text"
          name="title"
          placeholder="Title"
          [(ngModel)]="title"
          #titleInput="ngModel"
          required
          [ngClass]="{ 'invalid': !isValidTitle() && titleInput.touched }"
        >
        <div *ngIf="!isValidTitle() && formSubmitted" class="error-message">
          Invalid title. Only letters, numbers, and common punctuation allowed. Length: 2–50 chars.
        </div>
      </div>


      <div class="title">
        <input type="text"
               id="author"
               name="author"
               placeholder="Author"
               [(ngModel)]="author"
               #authorInput="ngModel"
               required
               [ngClass]="{ 'invalid': !isValidTitle() && authorInput.touched }"
        >
        <div *ngIf="!isValidAuthor() && formSubmitted" class="error-message">
          Invalid author. Only letters, numbers, and common punctuation allowed. Length: 2–50 chars.
        </div>
      </div>
      <div class="title">
        <textarea id="synopsis" [(ngModel)]="synopsis" name="synopsis" placeholder="Synopsys" rows="4" cols="50"></textarea>
      </div>


      <div class="state-container">
        <select id="state" [(ngModel)]="state" name="state" required>
          <option value="" disabled selected>State</option>
          <option value="In process">In process</option>
          <option value="Finished">Finished</option>
        </select>
        <div *ngIf="formSubmitted && state === ''" class="error-message">
          Please select a state.
        </div>
      </div>

      <div class="genre-container">
        <select
          id="genre"
          [(ngModel)]="selectedGenre"
          name="selectedGenre"
          [ngClass]="{ 'invalid': selectedGenres.length === 0 && formSubmitted }"
        >
          <option value="" disabled selected>Select Genre</option>
          <option *ngFor="let genre of genre" [value]="genre">{{ genre }}</option>
        </select>
        <button type="button" (click)="addGenre()">Add</button>
      </div>
      <div class="genre-list">
        <p>Selected Genres (click to remove):</p>
        <span
          *ngFor="let genre of selectedGenres"
          class="genre-item"
          (click)="removeGenre(genre)"
          style="cursor: pointer; margin-right: 8px;"
        >
    {{ genre }}
          <i class="fas fa-times" style="margin-left: 4px; color: red;"></i>
  </span>
      </div>


      <div *ngIf="selectedGenres.length === 0 && formSubmitted" class="error-message">
        Please select at least one genre.
      </div>

      <div *ngIf="uploadSuccess" class="message success-message">
        ✅ Upload Successful!
      </div>

      <div *ngIf="uploadError" class="message error-message">
        ⚠️ There was an error during the upload.
      </div>

      <div *ngIf="isUploadingFile" class="loading-overlay">
        <div class="spinner"></div>
        <p>Uploading...</p>
      </div>


      <div class="upload-button">
        <app-button text="UPLOAD"></app-button>
      </div>
    </div>
  </div>
</form>
